#cloud-config

locale: de_CH.utf8
timezone: Europe/Zurich
keyboard:
  layout: de-CH
  variant: nodeadkeys

autoinstall:
  shutdown: reboot

package_update: true
package_upgrade: true
package_reboot_if_required: true
packages:
  - qemu-guest-agent
  - ntp
  - ufw
  - fail2ban
  - policycoreutils 
  - libpam-pwquality
  - python3

ntp:
  enabled: true
  tp_client: chrony

users:
  - default

write_files:
  - encoding: text/plain
    content: |
      [DEFAULT]
      bantime = 8h
      ignoreip = 0.0.0.0
      ignoreself = true

      [sshd]
      enabled = true
      port = 22
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
    path: /etc/fail2ban/jail.local
    permissions: '0644'
  - encoding: text/plain
    content: |
      ----------------------------------
      |      ITSVC Infrastructure      |
      ----------------------------------
      
    path: /etc/motd
    permissions: '0644'
  - encoding: text/plain
    content: |
      Include /etc/ssh/sshd_config.d/*.conf
      PermitRootLogin no
      MaxAuthTries 5
      IgnoreRhosts yes
      PasswordAuthentication no
      HostbasedAuthentication no
      PermitEmptyPasswords no
      Ciphers aes128-ctr,aes192-ctr,aes256-ctr
      KbdInteractiveAuthentication no
      UsePAM yes
      X11Forwarding yes
      PrintMotd no
      AcceptEnv LANG LC_*
      Subsystem       sftp    /usr/lib/openssh/sftp-server
      Banner none
      Protocol 2
      X11Forwarding no
    path: /etc/ssh/sshd_config
    permissions: '0644'
  - encoding: text/plain
    content: |
      password        [success=1 default=ignore]      pam_unix.so obscure yescrypt remeber=10
      password        requisite                       pam_deny.so
      password        required                        pam_permit.so
    path: /etc/pam.d/common-password
    permissions: '0644'
  - encoding: text/plain
    content: |
      minlen = 8
      minclass = 2
      maxrepeat = 2
      maxclassrepeat = 4
      lcredit = -1
      ucredit = -1
      dcredit = -1
      ocredit = -1
      maxsequence = 2 
      difok = 5
      gecoscheck = 1
    path: /etc/security/pwquality.conf 
    permissions: '0644'
  - path: /etc/profile
    content: |
      touch ~/.sudo_as_admin_successful
    append: true

runcmd:
  - systemctl start qemu-guest-agent
  - chmod -x /etc/update-motd.d/*
  - mv /etc/legal /etc/legal.bak 
  - echo 1 > /proc/sys/net/ipv4/ip_forward

final_message: |
  cloud-init has finished
  version: $version
  timestamp: $timestamp
  datasource: $datasource
  uptime: $uptime

power_state:
    delay: now
    mode: reboot
    message: Reboot Maschine
    timeout: 2
    condition: true